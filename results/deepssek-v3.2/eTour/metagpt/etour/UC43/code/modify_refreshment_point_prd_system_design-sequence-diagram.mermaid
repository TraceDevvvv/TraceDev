sequenceDiagram
    participant Operator as 餐厅点操作员
    participant UI as 用户界面
    participant AuthController as 认证控制器
    participant AuthService as 认证服务
    participant PointController as 餐厅点控制器
    participant PointService as 餐厅点服务
    participant ValidationService as 验证服务
    participant PointRepository as 餐厅点仓库
    participant LogService as 日志服务
    participant ETOURService as ETOUR集成服务
    participant DB as 数据库
    
    %% 1. 用户认证流程
    Operator->>UI: 输入用户名密码
    UI->>AuthController: POST /api/auth/login
    AuthController->>AuthService: authenticate(username, password)
    AuthService->>DB: 查询用户信息
    DB-->>AuthService: 返回用户数据
    AuthService-->>AuthController: 生成JWT令牌
    AuthController-->>UI: 返回认证结果和令牌
    UI-->>Operator: 显示登录成功
    
    %% 2. 加载餐厅点数据流程
    Operator->>UI: 输入餐厅点ID并点击加载
    UI->>PointController: GET /api/points/{pointId}
    PointController->>AuthService: 验证令牌
    AuthService-->>PointController: 验证通过
    PointController->>PointService: getPointById(pointId)
    PointService->>PointRepository: findById(pointId)
    PointRepository->>DB: 查询餐厅点数据
    DB-->>PointRepository: 返回数据
    PointRepository-->>PointService: 返回RestaurantPoint对象
    PointService-->>PointController: 返回RestaurantPointDTO
    PointController-->>UI: 返回JSON数据
    UI-->>Operator: 显示餐厅点表单
    
    %% 3. 修改数据并验证流程
    Operator->>UI: 修改表单数据并点击验证
    UI->>PointController: POST /api/points/{pointId}/validate
    PointController->>AuthService: 验证令牌
    AuthService-->>PointController: 验证通过
    PointController->>ValidationService: validateRestaurantPoint(updatedData)
    ValidationService->>ValidationService: 执行字段验证
    ValidationService->>ValidationService: 执行业务规则验证
    ValidationService-->>PointController: 返回ValidationResultDTO
    PointController-->>UI: 返回验证结果
    UI-->>Operator: 显示验证结果（成功/失败）
    
    %% 4. 确认修改流程
    Operator->>UI: 点击确认修改
    UI->>PointController: PUT /api/points/{pointId}
    PointController->>AuthService: 验证令牌
    AuthService-->>PointController: 验证通过
    PointController->>PointService: updatePoint(pointId, updateData)
    
    PointService->>LogService: 记录操作开始
    PointService->>PointRepository: findById(pointId)
    PointRepository->>DB: 查询原数据
    DB-->>PointRepository: 返回原数据
    PointRepository-->>PointService: 返回RestaurantPoint对象
    
    PointService->>ValidationService: validateRestaurantPoint(updateData)
    ValidationService-->>PointService: 返回验证结果
    
    alt 验证失败
        PointService->>LogService: 记录验证失败
        PointService-->>PointController: 抛出ValidationException
    else 验证成功
        PointService->>ETOURService: checkConnection()
        alt ETOUR连接正常
            ETOURService-->>PointService: 连接正常
            PointService->>PointRepository: save(updatedPoint)
            PointRepository->>DB: 更新数据
            DB-->>PointRepository: 更新成功
            PointRepository-->>PointService: 返回保存的对象
            PointService->>ETOURService: updatePointInETOUR(pointId, updateData)
            ETOURService-->>PointService: 同步成功
            PointService->>LogService: 记录操作成功
            PointService-->>PointController: 返回更新后的RestaurantPointDTO
        else ETOUR连接失败
            ETOURService-->>PointService: 连接失败
            PointService->>PointRepository: save(updatedPoint)
            PointRepository->>DB: 更新数据
            DB-->>PointRepository: 更新成功
            PointRepository-->>PointService: 返回保存的对象
            PointService->>LogService: 记录ETOUR连接失败警告
            PointService-->>PointController: 返回更新后的RestaurantPointDTO（带警告）
        end
    end
    
    PointController-->>UI: 返回操作结果
    UI-->>Operator: 显示操作结果
    
    %% 5. 取消操作流程
    Operator->>UI: 点击取消
    UI->>PointController: POST /api/points/{pointId}/cancel
    PointController->>AuthService: 验证令牌
    AuthService-->>PointController: 验证通过
    PointController->>PointService: cancelOperation(pointId)
    PointService->>LogService: 记录操作取消
    PointService-->>PointController: 返回取消成功
    PointController-->>UI: 返回取消结果
    UI-->>Operator: 显示操作已取消
    
    %% 6. 错误处理流程
    Note over PointController,DB: 当发生异常时
    PointController->>PointController: 捕获异常
    PointController->>LogService: 记录异常
    PointController-->>UI: 返回错误响应
    UI-->>Operator: 显示错误信息