'''
Implements the graphical user interface for inserting a new user into the system.
This JFrame displays input fields for user details and a "Save" button.
It interacts with UserValidationService for data validation and UserManager
for user creation. Error messages are displayed using JOptionPane.
'''
import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
// Removed: import PasswordHasher; // No explicit import needed for classes in the same default package
public class NewUserForm extends JFrame implements ActionListener {
    // GUI Components
    private final JTextField nameField;
    private final JTextField surnameField;
    private final JTextField emailField;
    private final JTextField cellField;
    private final JTextField loginField;
    private final JPasswordField passwordField;
    private final JPasswordField confirmPasswordField;
    private final JButton saveButton;
    // Serv
    private final UserManager userManager;
    private final UserValidationService validationService;
    /**
     * Constructs the NewUserForm.
     * Sets up the JFrame, adds all input fields and buttons,
     * and initializes the UserManager and UserValidationService.
     *
     * @param userManager An instance of UserManager for adding users.
     * @param validationService An instance of UserValidationService for input validation.
     */
    public NewUserForm(UserManager userManager, UserValidationService validationService) {
        this.userManager = userManager;
        this.validationService = validationService;
        // --- JFrame Setup ---
        setTitle("New User Entry Form");
        setSize(400, 450);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE); // Closes the application when the form is closed.
        setLocationRelativeTo(null); // Center the window
        // Use a JPanel with BorderLayout for overall structure, and GridLayout for form fields
        JPanel mainPanel = new JPanel(new BorderLayout(10, 10)); // Padding
        mainPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20)); // Overall padding
        add(mainPanel);
        // --- Form Fields Panel (GridLayout for labels and fields) ---
        JPanel formPanel = new JPanel(new GridLayout(0, 2, 10, 10)); // 0 rows, 2 columns, 10px spacing
        // Initialize fields
        nameField = new JTextField(20);
        surnameField = new JTextField(20);
        emailField = new JTextField(20);
        cellField = new JTextField(20);
        loginField = new JTextField(20);
        passwordField = new JPasswordField(20);
        confirmPasswordField = new JPasswordField(20);
        saveButton = new JButton("Save");
        // Add components to the form panel
        formPanel.add(new JLabel("Name:"));
        formPanel.add(nameField);
        formPanel.add(new JLabel("Surname:"));
        formPanel.add(surnameField);
        formPanel.add(new JLabel("E-mail:"));
        formPanel.add(emailField);
        formPanel.add(new JLabel("Cell:"));
        formPanel.add(cellField);
        formPanel.add(new JLabel("Login:"));
        formPanel.add(loginField);
        formPanel.add(new JLabel("Password:"));
        formPanel.add(passwordField);
        formPanel.add(new JLabel("Confirm Password:"));
        formPanel.add(confirmPasswordField);
        mainPanel.add(formPanel, BorderLayout.CENTER);
        // --- Buttons Panel (FlowLayout for centering buttons) ---
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        buttonPanel.add(saveButton);
        mainPanel.add(buttonPanel, BorderLayout.SOUTH);
        // --- Add Action Listener to Save button ---
        saveButton.addActionListener(this);
    }
    /**
     * Handles action events, specifically the "Save" button click.
     * It retrieves user input, performs validation using UserValidationService,
     * hashes the password, and attempts to add the user via UserManager.
     * Displays success or error messages using JOptionPane.
     *
     * @param e The ActionEvent object generated by the button click.
     */
    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() == saveButton) {
            // Retrieve data from input fields
            String name = nameField.getText().trim();
            String surname = surnameField.getText().trim();
            String email = emailField.getText().trim();
            String cell = cellField.getText().trim();
            String login = loginField.getText().trim();
            String password = new String(passwordField.getPassword()); // Plaintext password for validation
            String confirmPassword = new String(confirmPasswordField.getPassword()); // Plaintext password for validation
            // Validate data using the UserValidationService
            String validationError = validationService.validate(
                name, surname, email, cell, login, password, confirmPassword
            );
            if (validationError != null) {
                // If validation fails, display an error message (case of use "Errodati")
                JOptionPane.showMessageDialog(this,
                                              validationError,
                                              "Data Entry Error",
                                              JOptionPane.ERROR_MESSAGE);
            } else {
                // If validation passes, hash the password before creating the User object
                String hashedPassword = PasswordHasher.hashPassword(password);
                // Attempt to create and add the new user
                User newUser = new User(name, surname, email, cell, login, hashedPassword);
                if (userManager.addUser(newUser)) {
                    // Success: new user created
                    JOptionPane.showMessageDialog(this,
                                                  "New user '" + login + "' created successfully!",
                                                  "Success",
                                                  JOptionPane.INFORMATION_MESSAGE);
                    // Clear the form after successful creation for subsequent entries
                    clearFormFields();
                    // Postcondition: new user created and administrator notified via dialog.
                    // The "interrupts the connection to the SMOS server interrupted"
                    // implies the current task is complete; clearing the form allows
                    // the administrator to create another user without closing the application.
                } else {
                    // This situation should ideally be caught by UserValidationService
                    // (e.g., if login was valid but then becomes taken just before save or
                    // deeper system error occurs), but as a fallback, show a generic error.
                    JOptionPane.showMessageDialog(this,
                                                  "Failed to add user. Login might be taken or other issue.",
                                                  "Error",
                                                  JOptionPane.ERROR_MESSAGE);
                }
            }
        }
    }
    /**
     * Clears all input fields in the form.
     */
    private void clearFormFields() {
        nameField.setText("");
        surnameField.setText("");
        emailField.setText("");
        cellField.setText("");
        loginField.setText("");
        passwordField.setText("");
        confirmPasswordField.setText("");
    }
}