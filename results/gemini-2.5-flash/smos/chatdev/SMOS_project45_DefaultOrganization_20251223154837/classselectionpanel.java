/*
 * GUI panel for displaying a list of classes and allowing the administrator to select one.
 * It provides a "View Students" button for the selected class.
 */
package gui;
import data.DataStore;
import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.util.List;
import java.util.function.BiConsumer;
public class ClassSelectionPanel extends JPanel {
    private JList<String> classList;
    private DefaultListModel<String> listModel;
    private JButton viewStudentsButton;
    private String currentAcademicYear; // The academic year currently in scope
    private BiConsumer<String, String> onClassSelected; // Callback: (academicYear, className)
    private DataStore dataStore; // Add DataStore instance
    /**
     * Constructs a new ClassSelectionPanel.
     * @param dataStore The DataStore instance for retrieving classes and students.
     * @param onClassSelected A callback function to be executed when a class is selected.
     *                        The selected academic year and class name are passed as arguments.
     */
    public ClassSelectionPanel(DataStore dataStore, BiConsumer<String, String> onClassSelected) { // Modify constructor
        this.dataStore = dataStore; // Assign dataStore
        this.onClassSelected = onClassSelected;
        setLayout(new BorderLayout(10, 10));
        setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        // Panel for title
        JPanel titlePanel = new JPanel();
        titlePanel.add(new JLabel("<html><h2>Choose Pupil Class</h2></html>"));
        add(titlePanel, BorderLayout.NORTH);
        // Class list display
        listModel = new DefaultListModel<>();
        classList = new JList<>(listModel);
        classList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION); // Only one class can be selected at a time
        JScrollPane scrollPane = new JScrollPane(classList);
        scrollPane.setPreferredSize(new Dimension(300, 200));
        add(scrollPane, BorderLayout.CENTER);
        // Control Panel with buttons
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 10, 10));
        viewStudentsButton = new JButton("View Students");
        viewStudentsButton.addActionListener(this::handleViewStudentsClick);
        viewStudentsButton.setEnabled(false); // Initially disabled until a class is selected
        buttonPanel.add(viewStudentsButton);
        add(buttonPanel, BorderLayout.SOUTH);
        // Enable/disable button based on list selection
        classList.addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting()) { // Ensures this event fires only once per selection change
                viewStudentsButton.setEnabled(classList.getSelectedIndex() != -1);
            }
        });
    }
    /**
     * Sets the academic year and populates the class list for that year.
     * @param academicYear The academic year selected by the user.
     */
    public void setAcademicYear(String academicYear) {
        this.currentAcademicYear = academicYear;
        listModel.clear(); // Clear previous classes
        // Use the injected DataStore instance
        List<String> classes = dataStore.getClassesForYear(academicYear);
        if (classes.isEmpty()) {
            listModel.addElement("No classes available for " + academicYear);
            classList.setEnabled(false);
            classList.clearSelection(); // Clear selection when no classes
        } else {
             classList.setEnabled(true);
            for (String className : classes) {
                listModel.addElement(className);
            }
        }
        viewStudentsButton.setEnabled(false); // Reset button state
    }
    /**
     * Handles the click event for the "View Students" button.
     * Retrieves the selected class and invokes the callback.
     * @param e The ActionEvent generated by the button click.
     */
    private void handleViewStudentsClick(ActionEvent e) {
        String selectedClass = classList.getSelectedValue();
        if (selectedClass != null && currentAcademicYear != null) {
            // Use the injected DataStore instance for validation
            // Check if it's the "No classes available" placeholder
            if (listModel.getSize() == 1 && listModel.getElementAt(0).equals("No classes available for " + currentAcademicYear)) {
                 JOptionPane.showMessageDialog(this, "No valid class selected.", "Selection Error", JOptionPane.WARNING_MESSAGE);
            }
            else if (onClassSelected != null) {
                onClassSelected.accept(currentAcademicYear, selectedClass);
            }
        } else {
            JOptionPane.showMessageDialog(this, "Please select a class to view students.", "Selection Error", JOptionPane.WARNING_MESSAGE);
        }
    }
}