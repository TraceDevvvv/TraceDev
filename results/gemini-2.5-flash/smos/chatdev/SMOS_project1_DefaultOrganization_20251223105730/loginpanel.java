'''
This JPanel represents the login form itself.
It contains input fields for username and password, a login button,
and a label to display messages (errors or success).
It interacts with AuthService for login validation and LoginFrame for post-login actions.
'''
import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.Arrays; // Added for clearing password char array
public class LoginPanel extends JPanel implements ActionListener {
    // GUI Components
    private JTextField usernameField;
    private JPasswordField passwordField;
    private JButton loginButton;
    private JLabel messageLabel;
    // Service for handling authentication logic
    private AuthService authService;
    // Reference to the parent LoginFrame to trigger post-login actions
    private LoginFrame parentFrame;
    /**
     * Constructs a LoginPanel.
     *
     * @param authService The AuthService instance to handle login logic.
     * @param parentFrame The parent LoginFrame to call methods on after successful login.
     */
    public LoginPanel(AuthService authService, LoginFrame parentFrame) {
        this.authService = authService;
        this.parentFrame = parentFrame;
        // Use GridBagLayout for flexible and robust component placement
        setLayout(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5, 5, 5, 5); // Padding around components
        gbc.fill = GridBagConstraints.HORIZONTAL; // Components fill horizontal space
        // Initialize components
        JLabel usernameLabel = new JLabel("Username:");
        usernameField = new JTextField(15); // Preferred width for text field
        JLabel passwordLabel = new JLabel("Password:");
        passwordField = new JPasswordField(15); // Preferred width for password field
        loginButton = new JButton("Login");
        messageLabel = new JLabel(""); // Initially empty message label
        messageLabel.setForeground(Color.RED); // Set default color for error messages
        // Add components to the panel using GridBagLayout
        // Username Label
        gbc.gridx = 0; // Column 0
        gbc.gridy = 0; // Row 0
        add(usernameLabel, gbc);
        // Username Field
        gbc.gridx = 1; // Column 1
        gbc.gridy = 0; // Row 0
        gbc.gridwidth = 2; // Span 2 columns
        add(usernameField, gbc);
        // Password Label
        gbc.gridx = 0; // Column 0
        gbc.gridy = 1; // Row 1
        gbc.gridwidth = 1; // Reset to 1 column span
        add(passwordLabel, gbc);
        // Password Field
        gbc.gridx = 1; // Column 1
        gbc.gridy = 1; // Row 1
        gbc.gridwidth = 2; // Span 2 columns
        add(passwordField, gbc);
        // Login Button
        gbc.gridx = 1; // Column 1
        gbc.gridy = 2; // Row 2
        gbc.gridwidth = 1; // Span 1 column
        gbc.anchor = GridBagConstraints.CENTER; // Center button horizontally
        add(loginButton, gbc);
        // Message Label
        gbc.gridx = 0; // Column 0
        gbc.gridy = 3; // Row 3
        gbc.gridwidth = 3; // Span all 3 columns
        gbc.weightx = 1.0; // Give extra horizontal space to this component
        gbc.anchor = GridBagConstraints.CENTER; // Center message horizontally
        add(messageLabel, gbc);
        // Register the loginButton to listen for action events (e.g., clicks)
        loginButton.addActionListener(this);
    }
    /**
     * Handles action events, specifically the login button click.
     * This is where the core login business logic is triggered from the GUI.
     * Passwords are retrieved as char arrays from JPasswordField and passed directly
     * to the AuthService for enhanced security, avoiding String conversion where possible.
     *
     * @param e The ActionEvent generated by the button click.
     */
    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() == loginButton) {
            String username = usernameField.getText();
            // Get password as char array directly from JPasswordField for better security
            char[] passwordChars = passwordField.getPassword();
            try {
                // Attempt to authenticate using the AuthService, passing char array directly
                boolean isAuthenticated = authService.authenticate(username, passwordChars);
                if (isAuthenticated) {
                    // Event Sequence 3: If the search was successful, the user is logged in to the system
                    messageLabel.setForeground(new Color(0, 128, 0)); // Green color for success
                    messageLabel.setText("Login successful!");
                    // Postconditions: The system displays the registered user workspace
                    parentFrame.showUserWorkspace(username);
                } else {
                    // If authentication failed (credentials not found)
                    messageLabel.setForeground(Color.RED);
                    messageLabel.setText("Invalid username or password.");
                }
            } catch (IllegalArgumentException ex) {
                // Handle the case where username/password length is less than 5
                // Event Sequence 1: notify the user error
                messageLabel.setForeground(Color.RED);
                messageLabel.setText(ex.getMessage());
            } catch (Exception ex) {
                // Catch any other unexpected errors
                messageLabel.setForeground(Color.RED);
                messageLabel.setText("An unexpected error occurred. Please try again.");
                // Log the exception for debugging purposes (in a real application, use a logger)
                ex.printStackTrace(); 
            } finally {
                // IMPORTANT SECURITY STEP: Clear the char array immediately after use
                // This reduces the window of opportunity for sensitive data to be exposed in memory.
                if (passwordChars != null) {
                    Arrays.fill(passwordChars, ' '); // Overwrite contents with blanks
                }
                // Also clear the JPasswordField display
                passwordField.setText(null); 
            }
        }
    }
}