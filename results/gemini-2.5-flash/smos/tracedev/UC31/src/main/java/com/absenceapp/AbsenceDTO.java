package com.absenceapp;

import java.util.Date;

/**
 * Data Transfer Object for Absence records.
 * Used for transferring absence data between layers, especially for UI interactions.
 */
public class AbsenceDTO {
    public static final String STATUS_NEW = "NEW";
    public static final String STATUS_MODIFIED = "MODIFIED";
    public static final String STATUS_DELETED = "DELETED"; // Used as an operational status for the DTO
    public static final String STATUS_UNCHANGED = "UNCHANGED"; // Used to track DTOs fetched from DB but not modified

    public String id;
    public String studentId;
    public Date date;
    public String type; // String representation of AbsenceType
    public String reason;
    public String status; // Can be used to indicate ADDED, MODIFIED, DELETED for frontend, or AbsenceStatus for existing records

    public AbsenceDTO() {
        // Default constructor
    }

    public AbsenceDTO(String id, String studentId, Date date, String type, String reason, String status) {
        this.id = id;
        this.studentId = studentId;
        this.date = date;
        this.type = type;
        this.reason = reason;
        this.status = status;
    }

    /**
     * Converts this AbsenceDTO to an Absence domain object.
     * The 'status' field in DTO might represent a change operation (NEW, MODIFIED, DELETED)
     * or an actual AbsenceStatus. This method assumes it represents AbsenceStatus for the domain object.
     * If the DTO's ID is null/empty and type/reason/date are present, it implies a new absence creation.
     * The actual AbsenceStatus (e.g., PENDING) needs to be set appropriately,
     * not necessarily from the DTO's operational status.
     *
     * @return An Absence object.
     */
    public Absence toAbsence() {
        AbsenceType absenceType = null;
        if (this.type != null) {
            try {
                absenceType = AbsenceType.valueOf(this.type);
            } catch (IllegalArgumentException e) {
                // Log error or handle invalid type string
                System.err.println("Warning: Invalid AbsenceType in DTO: " + this.type);
                absenceType = AbsenceType.ABSENT; // Default to a safe value
            }
        }

        // When converting DTO to Absence, the DTO's 'status' field (if it represents NEW/MODIFIED/DELETED)
        // is an operational status for the UI/Controller, not the domain object's AbsenceStatus.
        // We'll set a default status or infer it for the domain object.
        AbsenceStatus absenceStatus = AbsenceStatus.PENDING; // Default status for new/modified absences
        if (this.status != null && !this.status.equals(STATUS_NEW) && !this.status.equals(STATUS_MODIFIED) && !this.status.equals(STATUS_DELETED)) {
            try {
                absenceStatus = AbsenceStatus.valueOf(this.status);
            } catch (IllegalArgumentException e) {
                System.err.println("Warning: Invalid AbsenceStatus in DTO for domain object: " + this.status);
            }
        }

        // If ID is null, it's a new Absence, its ID will be generated by the Absence constructor.
        // If ID exists, it's an existing Absence.
        return new Absence(this.id, this.studentId, this.date, absenceType, this.reason, absenceStatus);
    }

    /**
     * Converts an Absence domain object to an AbsenceDTO.
     * The DTO's status field will reflect the Absence's actual status (e.g., PENDING, APPROVED).
     *
     * @param absence The Absence object to convert.
     * @return An AbsenceDTO.
     */
    public static AbsenceDTO fromAbsence(Absence absence) {
        if (absence == null) {
            return null;
        }
        return new AbsenceDTO(
                absence.getId(),
                absence.getStudentId(),
                absence.getDate(),
                absence.getType() != null ? absence.getType().name() : null,
                absence.getReason(),
                absence.getStatus() != null ? absence.getStatus().name() : null
        );
    }

    /**
     * Creates a new AbsenceDTO instance marked as 'NEW'.
     *
     * @param studentId The ID of the student.
     * @param date The date of the absence.
     * @param type The type of absence (as a String).
     * @param reason The reason for the absence.
     * @return A new AbsenceDTO.
     */
    public static AbsenceDTO createNew(String studentId, Date date, String type, String reason) {
        AbsenceDTO dto = new AbsenceDTO(null, studentId, date, type, reason, STATUS_NEW);
        return dto;
    }

    @Override
    public String toString() {
        return "AbsenceDTO{" +
                "id='" + id + '\'' +
                ", studentId='" + studentId + '\'' +
                ", date=" + date +
                ", type='" + type + '\'' +
                ", reason='" + reason + '\'' +
                ", status='" + status + '\'' +
                '}';
    }
}