package com.example.infrastructure;

import com.example.domain.Feedback;
import java.util.Optional;
import java.util.List;
import java.util.ArrayList;
import java.util.stream.Collectors;
import java.util.Random; // For simulating connection interruption

/**
 * Repository for managing Feedback entities.
 * Simulates persistence operations (e.g., database interactions).
 */
public class FeedbackRepository {

    // In-memory store for demonstration purposes
    private final List<Feedback> feedbackStore = new ArrayList<>();
    private final Random random = new Random(); // For simulating connection issues

    /**
     * Finds feedback submitted by a specific tourist for a specific site.
     * @param touristId The ID of the tourist.
     * @param siteId The ID of the site.
     * @return An Optional containing the Feedback if found, otherwise empty.
     */
    public Optional<Feedback> findByTouristAndSite(String touristId, String siteId) {
        System.out.println("[DB] Searching for feedback from tourist '" + touristId + "' for site '" + siteId + "'...");
        return feedbackStore.stream()
                .filter(f -> f.getTouristId().equals(touristId) && f.getSiteId().equals(siteId))
                .findFirst();
    }

    /**
     * Saves a Feedback entity. If the feedbackId already exists, it updates; otherwise, it adds.
     * For this simulation, we always add or find, the ID is generated by the domain.
     * @param feedback The Feedback object to save.
     * @return The saved Feedback object.
     * @throws RuntimeException if a simulated connection interruption occurs.
     */
    public Feedback save(Feedback feedback) {
        // Simulate a connection interruption with a 10% chance
        if (random.nextInt(10) < 1) { // 10% chance
            System.err.println("[DB] Simulated connection interruption during Feedback save!");
            throw new RuntimeException("Simulated connection interruption to server ETOUR.");
        }

        System.out.println("[DB] Saving feedback: " + feedback.getFeedbackId());
        // In a real scenario, this would involve database insert/update logic.
        // For simplicity, we just add it to our in-memory list.
        // Assuming 'feedback' object already has a unique ID from the domain layer.
        feedbackStore.add(feedback);
        System.out.println("[DB] Feedback saved successfully.");
        return feedback;
    }

    // Utility for testing: retrieve all feedback
    public List<Feedback> findAll() {
        return new ArrayList<>(feedbackStore);
    }
}