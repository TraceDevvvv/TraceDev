package com.example.culturalgoods.repository;

import com.example.culturalgoods.model.CulturalGood;
import com.example.culturalgoods.exception.ConnectionException;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

/**
 * Concrete implementation of ICulturalGoodRepository.
 * This implementation uses an in-memory list to simulate a database.
 */
public class CulturalGoodRepositoryImpl implements ICulturalGoodRepository {
    // In-memory list to simulate the "CulturalGood Database"
    private final List<CulturalGood> culturalGoods;
    // Flag to simulate connection issues as per sequence diagram
    private boolean simulateConnectionError = false;

    public CulturalGoodRepositoryImpl() {
        this.culturalGoods = Collections.synchronizedList(new ArrayList<>()); // Thread-safe list for potential multi-threading, though not strictly needed here
    }

    /**
     * Sets a flag to simulate a connection error during save operations.
     * @param simulateConnectionError True to simulate an error, false otherwise.
     */
    public void setSimulateConnectionError(boolean simulateConnectionError) {
        this.simulateConnectionError = simulateConnectionError;
    }

    /**
     * Saves a CulturalGood entity to the in-memory list.
     * If the cultural good has an ID, it tries to update an existing one.
     * Otherwise, it's treated as a new entry.
     *
     * @param culturalGood The CulturalGood entity to save.
     * @return The saved CulturalGood entity.
     * @throws ConnectionException if simulateConnectionError is true.
     */
    @Override
    public CulturalGood save(CulturalGood culturalGood) throws ConnectionException {
        if (simulateConnectionError) {
            // Simulate DB --x ICulturalGoodRepository: ConnectionError
            throw new ConnectionException("Simulated connection error to CulturalGood Database.");
        }

        // Check if an existing CulturalGood with the same ID exists for update
        // Or if its name already exists (though 'existsByName' should prevent this for new items)
        Optional<CulturalGood> existingGood = culturalGoods.stream()
                .filter(cg -> (culturalGood.getId() != null && cg.getId().equals(culturalGood.getId())) ||
                               cg.getName().equals(culturalGood.getName())) // Using name check for simplicity, assuming name is unique and acts as identifier pre-ID
                .findFirst();

        if (existingGood.isPresent()) {
            // Update existing cultural good
            CulturalGood foundGood = existingGood.get();
            foundGood.setName(culturalGood.getName());
            foundGood.setDescription(culturalGood.getDescription());
            foundGood.setAcquisitionDate(culturalGood.getAcquisitionDate());
            // ID should not change if it already exists
            System.out.println("[DB] Updated CulturalGood: " + foundGood.getName());
            return foundGood;
        } else {
            // This is a new cultural good, add it. ID should have been generated by service.
            culturalGoods.add(culturalGood);
            System.out.println("[DB] Persisted new CulturalGood: " + culturalGood.getName());
            return culturalGood;
        }
    }

    /**
     * Checks if a cultural good with the given name already exists in the in-memory list.
     *
     * @param name The name to check for existence.
     * @return true if a cultural good with the given name exists, false otherwise.
     */
    @Override
    public boolean existsByName(String name) {
        boolean exists = culturalGoods.stream()
                .anyMatch(culturalGood -> culturalGood.getName().equalsIgnoreCase(name));
        System.out.println("[DB] Query for existence of '" + name + "': " + exists);
        return exists;
    }
}